# 使用指南

本文档提供系统的详细使用说明，包括命令行工具、API使用和自动预约设置。

## 命令行工具（CLI）

系统提供了交互式命令行工具，可以方便地查询和预约场馆。

### 启动命令行工具

```bash
python cli.py
```

### 使用流程

1. **输入日期和场馆类型**

系统会提示您输入希望预约的日期和场馆类型：

```
请输入希望预约的日期 (格式: YYYY-MM-DD): 2024-04-01
请输入场馆类型的 serviceid: 22
```

> 注意：场馆类型ID（serviceid）通常为22（篮球场）

2. **选择场馆**

系统会展示符合条件的可用场馆列表：

```
0. 场馆: 篮球场1号, 时间: 20:01-21:00, stockid: 10381
1. 场馆: 篮球场2号, 时间: 20:01-21:00, stockid: 10382
2. 场馆: 篮球场3号, 时间: 20:01-21:00, stockid: 10383
请选择一个场馆: 
```

输入场馆对应的序号（例如：1）选择场馆。

3. **输入随行人员**

系统将提示您输入随行人员ID：

```
你选择了 篮球场2号，时间: 20:01-21:00
请输入随行人员的 ID (多个ID用逗号分隔): 160734/160747
```

输入格式为学工号，多个人员ID之间用`/`分隔。

4. **完成预约**

系统会使用您提供的信息进行预约，并显示预约结果：

```
预约成功！
预约成功，场地：篮球场2号，日期：2024-04-01，时间：20:01-21:00
```

如果预约失败，系统会显示错误原因：

```
预约失败：未到该日期的预订时间
```

或

```
预约失败：每日限预约一场
```

### 常见问题

- **找不到场馆数据**：如果系统无法找到指定日期的数据，会自动从外部系统获取
- **预约时间限制**：预约可能受到时间限制，例如只能在指定时间段内预约
- **重复预约限制**：系统可能限制同一用户一天只能预约一场

## API使用

除了命令行工具，系统还提供了REST API接口，可以通过HTTP请求进行操作。

### 查询场馆

使用GET请求查询指定日期和类型的可用场馆：

```bash
curl -X GET "http://localhost:8000/api/v1/venues?serviceid=22&date=2024-04-01"
```

或使用Python：

```python
import requests

response = requests.get(
    "http://localhost:8000/api/v1/venues",
    params={"serviceid": 22, "date": "2024-04-01"}
)
venues = response.json()
print(f"找到 {len(venues)} 个可用场馆")
```

### 创建预约

使用POST请求创建预约：

```bash
curl -X POST "http://localhost:8000/api/v1/bookings" \
  -H "Content-Type: application/json" \
  -d '{"venue_id": 1, "users": ["160734", "160747"]}'
```

或使用Python：

```python
import requests

response = requests.post(
    "http://localhost:8000/api/v1/bookings",
    json={"venue_id": 1, "users": ["160734", "160747"]}
)
print(f"预约结果: {response.json()}")
```

### 直接预约

使用POST请求直接调用外部系统API进行预约：

```bash
curl -X POST "http://localhost:8000/api/v1/prebook" \
  -H "Content-Type: application/json" \
  -d '{
    "stockid": "10382",
    "serviceid": "22",
    "venue_id": "144995",
    "users": "160734,160747",
    "username": "22011207",
    "password": "password"
  }'
```

### 更多API

系统提供的完整API列表及使用方法请参考[API参考](api.md)文档。

## 自动预约

系统支持自动定时预约功能，可以在指定时间自动执行预约任务。

### 配置自动预约

1. 编辑`config_setup.py`文件，设置预约参数：

```python
# 预约参数设置
serviceid = '22'  # 场馆类型ID
stockid = '10382'  # 场地编号
stockdetail_id = '144995'  # 场地详细ID
users = '160734'  # 随行人员ID
```

2. 设置预约执行时间（在`config.py`中）：

```python
# 定时任务执行时间
SCHEDULE_TIME = "08:00"  # 每天8点执行
```

3. 设置可预约时间范围（在`config.py`中）：

```python
# 预约时间规则
BOOKING_HOURS = (8, 23)  # 允许预约的时间段
```

### 启动自动预约

运行调度器启动自动预约功能：

```bash
python scheduler.py
```

启动后，系统会在每天指定时间自动执行预约任务。

输出示例：
```
设置定时任务，每天 08:00 执行
当前时间在可预约时间段内，开始执行预约流程...
预约成功！
预约成功，场地：篮球场2号，日期：2024-04-01，时间：20:01-21:00
```

### 注意事项

- 请确保服务器时间正确
- 定时任务运行期间需保持程序运行
- 建议在生产环境使用系统服务（如systemd）管理定时任务

## 数据管理

系统会自动管理场馆数据，但您也可以手动触发数据操作。

### 手动导入数据

使用API导入指定日期的数据：

```bash
curl -X POST "http://localhost:8000/api/v1/import-data" \
  -H "Content-Type: application/json" \
  -d '{"date": "2024-04-01", "serviceid": 22}'
```

### 查看JSON数据文件

系统会将从外部API获取的数据保存在`data`目录下的JSON文件中：

```
data/service_data_22_2024-04-01.json
```

文件命名格式为：`service_data_{serviceid}_{date}.json`

### 数据库文件

系统使用SQLite数据库存储数据，数据库文件位于：

```
data/reservation.db
```

您可以使用SQLite工具查看和管理数据库内容。

## 使用场景

### 场景一：手动预约特定场馆

1. 运行CLI工具：`python cli.py`
2. 输入日期和场馆类型
3. 从列表中选择希望预约的场馆
4. 输入随行人员ID
5. 完成预约

### 场景二：自动定时预约

1. 编辑`config_setup.py`设置预约参数
2. 运行调度器：`python scheduler.py`
3. 系统会在指定时间自动执行预约
4. 观察输出查看预约结果

### 场景三：API集成

1. 向`/api/v1/venues`发送GET请求获取可用场馆
2. 选择目标场馆
3. 向`/api/v1/bookings`发送POST请求创建预约
4. 处理返回结果

## 故障排除

### 登录失败

**问题**：无法登录到原系统
**解决方案**：
1. 检查`config.py`中的登录信息是否正确
2. 确认外部系统是否可访问
3. 尝试手动登录原系统验证账号是否有效

### 预约失败

**问题**：预约请求失败
**解决方案**：
1. 检查错误信息，了解失败原因
2. 确认是否在允许的预约时间内
3. 确认是否已达到每日预约限制
4. 检查场馆是否仍然可用（可能已被他人预约）

### 数据获取失败

**问题**：无法获取场馆数据
**解决方案**：
1. 检查网络连接
2. 确认外部API是否可访问
3. 检查日期格式是否正确
4. 尝试手动访问API验证其可用性

### 定时任务不执行

**问题**：自动预约没有在指定时间执行
**解决方案**：
1. 确认程序正在运行
2. 检查系统时间是否正确
3. 查看日志了解任务是否被触发
4. 确认配置的执行时间格式是否正确 